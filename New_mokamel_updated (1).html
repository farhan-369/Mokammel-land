<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="فروشگاه آنلاین مکمل‌های بدنسازی شامل پروتئین، کراتین، گینر و سایر مکمل‌های ورزشی با بهترین کیفیت و قیمت">
    <meta property="og:title" content="فروشگاه مکمل ورزشی - خرید آنلاین مکمل‌های بدنسازی">
    <meta property="og:description" content="خرید آنلاین انواع مکمل‌های ورزشی با تضمین کیفیت و بهترین قیمت">
    <meta property="og:image" content="https://example.com/images/logo.png">
    <meta property="og:url" content="https://example.com">
    <meta name="keywords" content="مکمل ورزشی, پروتئین, کراتین, گینر, بدنسازی, مکمل بدنسازی">
    <title>فروشگاه مکمل ورزشی</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="Style.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">فروشگاه مکمل ورزشی</div>
            <div class="search-box">
                <input type="text" placeholder="جستجوی محصولات..." id="search-input">
                <button id="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="auth-buttons">
                <button id="login-btn">ورود</button>
                <button id="register-btn">ثبت نام</button>
            </div>
            <div class="theme-switch">
                <input type="checkbox" id="dark-mode-toggle">
                <label for="dark-mode-toggle">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                </label>
            </div>
        </div>
    </header>
    
    <div class="loader" id="loader" style="display: none;">
        <div class="loader-spinner"></div>
        <p>در حال بارگذاری...</p>
    </div>
    
    <!-- Main Content -->
    <div class="container main-content">
        <!-- Home Page -->
        <div id="home-page">
            <h2 class="page-title">محصولات</h2>
            
            <!-- Filters - Only shown on home page -->
            <div class="filters" id="filters-container">
                <div class="filter-group">
                    <h3>محدوده قیمت</h3>
                    <div class="price-inputs">
                        <input type="number" id="min-price" placeholder="حداقل قیمت" min="0" max="10000000" value="0">
                        <input type="number" id="max-price" placeholder="حداکثر قیمت" min="0" max="10000000" value="10000000">
                    </div>
                    <input type="range" class="price-range" min="0" max="10000000" step="100000" value="10000000">
                    <div class="price-values">
                        <span>0 تومان</span>
                        <span>5,000,000 تومان</span>
                        <span>10,000,000 تومان</span>
                    </div>
                </div>
                <div class="filter-group">
                    <h3>برندها</h3>
                    <div class="brand-list">
                        <div class="brand-item active">همه</div>
                        <div class="brand-item">Optimum Nutrition</div>
                        <div class="brand-item">MuscleTech</div>
                        <div class="brand-item">BSN</div>
                        <div class="brand-item">Dymatize</div>
                        <div class="brand-item">Cellucor</div>
                    </div>
                </div>
            </div>
            
            <div class="categories" id="categories-container">
                <!-- Categories will be loaded dynamically -->
            </div>
            
            <div class="products" id="products-container">
                <!-- Products will be loaded dynamically -->
            </div>
        </div>
        
        <!-- Product Detail Page -->
        <div id="product-detail-page" style="display: none;">
            <button class="back-btn" onclick="showPage('home')">
                <i class="fas fa-arrow-right"></i> بازگشت به محصولات
            </button>
            <!-- Product detail will be loaded dynamically -->
        </div>
        
        <!-- Shopping Cart Page -->
        <div id="cart-page" style="display: none;">
            <h2 class="page-title">سبد خرید</h2>
            <div class="cart-container" id="cart-container">
                <!-- Cart items will be loaded dynamically -->
            </div>
        </div>
        
        <!-- Checkout Page -->
        <div id="checkout-page" style="display: none;">
            <h2 class="page-title">تکمیل سفارش</h2>
            <div class="checkout-container" id="checkout-container">
                <!-- Checkout content will be loaded dynamically -->
            </div>
        </div>
        
        <!-- Orders Page -->
        <div id="orders-page" style="display: none;">
            <h2 class="page-title">سفارشات من</h2>
            <div class="orders-container" id="orders-container">
                <!-- Orders will be loaded dynamically -->
            </div>
        </div>
        
        <!-- Profile Page -->
        <div id="profile-page" style="display: none;">
            <h2 class="page-title">حساب کاربری</h2>
            <div class="profile-container" id="profile-container">
              
            </div>
        </div>    
    
    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-section">
                <h3>درباره ما</h3>
                <p>فروشگاه مکمل ورزشی با بیش از 10 سال سابقه در زمینه تأمین مکمل‌های ورزشی با کیفیت برای ورزشکاران و بدنسازان عزیز فعالیت می‌کند.</p>
            </div>
            <div class="footer-section">
                <h3>لینک‌های مفید</h3>
                <a href="#">صفحه اصلی</a>
                <a href="#">محصولات</a>
                <a href="#">مقالات</a>
                <a href="#">تماس با ما</a>
            </div>
            <div class="footer-section">
                <h3>تماس با ما</h3>
                <p>تهران، خیابان آزادی، پلاک 123</p>
                <p>تلفن: 021-12345678</p>
                <p>ایمیل: info@example.com</p>
            </div>
            <div class="footer-bottom">
                <p>تمامی حقوق برای فروشگاه مکمل ورزشی محفوظ است © 1402</p>
            </div>
        </div>
    </footer>
    
    <!-- Bottom Navigation -->
    <div class="nav-bottom">
        <div class="nav-item active" id="nav-home">
            <i><i class="fas fa-home"></i></i>
            <span>خانه</span>
        </div>
        <div class="nav-item" id="nav-cart">
            <i><i class="fas fa-shopping-cart"></i></i>
            <span>سبد خرید</span>
            <div class="cart-count" id="cart-count" style="display: none;"></div>
        </div>
        <div class="nav-item" id="nav-orders">
            <i><i class="fas fa-box"></i></i>
            <span>سفارشات</span>
        </div>
        <div class="nav-item" id="nav-profile">
            <i><i class="fas fa-user"></i></i>
            <span>پروفایل</span>
        </div>
    </div>
    
    <!-- Support Button -->
    <div class="support-btn" id="support-btn">
        <i class="fas fa-comment-dots"></i>
    </div>
    
    <!-- Toast Message -->
    <div class="toast" id="toast-message"></div>
    
    <!-- Zoom Modal -->
    <div class="zoom-modal" id="zoom-modal">
        <div class="zoom-content">
            <button class="close-zoom" id="close-zoom">خروج</button>
            <img id="zoomed-image" src="" alt="تصویر بزرگ شده">
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="auth-modal-title">ورود به حساب کاربری</h3>
                <button class="close-modal" id="close-auth-modal">&times;</button>
            </div>
            <form id="auth-form">
                <div id="login-fields">
                    <div class="form-group">
                        <label for="login-phone">شماره تماس</label>
                        <input type="text" id="login-phone" placeholder="09123456789">
                    </div>
                    <div class="form-group">
                        <label for="login-password">رمز عبور</label>
                        <input type="password" id="login-password" placeholder="رمز عبور">
                        <button type="button" class="password-toggle" id="login-password-toggle"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                
                <div id="register-fields" style="display: none;">
                    <div class="form-group">
                        <label for="register-name">نام کامل</label>
                        <input type="text" id="register-name" placeholder="نام و نام خانوادگی">
                    </div>
                    <div class="form-group">
                        <label for="register-national">کد ملی</label>
                        <input type="text" id="register-national" placeholder="کد ملی 10 رقمی">
                    </div>
                    <div class="form-group">
                        <label for="register-phone">شماره تماس</label>
                        <input type="text" id="register-phone" placeholder="09123456789">
                    </div>
                    <div class="form-group">
                        <label for="register-email">ایمیل</label>
                        <input type="email" id="register-email" placeholder="example@gmail.com">
                    </div>
                    <div class="form-group">
                        <label for="register-address">آدرس</label>
                        <input type="text" id="register-address" placeholder="آدرس کامل">
                    </div>
                    <div class="form-group">
                        <label for="register-password">رمز عبور</label>
                        <input type="password" id="register-password" placeholder="رمز عبور">
                        <button type="button" class="password-toggle" id="register-password-toggle"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                
                <button type="submit" class="form-submit" id="auth-submit-btn">ورود</button>
                <div class="form-switch">
                    <span id="auth-switch-text">حساب کاربری ندارید؟</span>
                    <button type="button" id="auth-switch-btn">ثبت نام</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">پرداخت آنلاین</h3>
                <button class="close-modal" id="close-payment-modal">&times;</button>
            </div>
            <div class="payment-gateway" id="payment-gateway">
                <h3>درگاه پرداخت بانک ملت</h3>
                <div class="payment-card">
                    <input type="text" placeholder="شماره کارت" maxlength="16" id="card-number">
                    <input type="text" placeholder="تاریخ انقضا (ماه/سال)" maxlength="5" id="card-expiry">
                    <input type="text" placeholder="CVV2" maxlength="4" id="card-cvv">
                </div>
                <div class="payment-actions">
                    <button class="payment-confirm" id="confirm-payment">پرداخت</button>
                    <button class="payment-cancel" id="cancel-payment">انصراف</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Avatar Upload Modal -->
    <div class="modal-overlay" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تغییر تصویر پروفایل</h3>
                <button class="close-modal" id="close-avatar-modal">&times;</button>
            </div>
            <div class="form-group">
                <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                <button class="form-submit" id="select-avatar-btn">انتخاب تصویر</button>
            </div>
            <div id="avatar-preview-container" style="display: none; margin-top: 15px; text-align: center;">
                <img id="avatar-preview" src="" alt="پیش‌نمایش تصویر" style="max-width: 200px; max-height: 200px; border-radius: 50%;">
                <button class="form-submit" id="save-avatar-btn" style="margin-top: 15px;">ذخیره تصویر</button>
            </div>
        </div>
    </div>
    
    <script>
        // App State
        const state = {
            currentPage: 'home',
            currentProfileTab: 'account',
            isLoggedIn: false,
            currentUserIndex: -1,
            users: [],
            cart: [],
            wishlist: [],
            orders: [],
            products: [
                {
                    id: 1,
                    name: "پروتئین وی ایزوله اپتیموم نوتریشن 2 کیلویی",
                    price: 3500000,
                    category: "پروتئین",
                    brand: "Optimum Nutrition",
                    images: [
                        "images/protein whey isoley.jpg",
                        "images/protein whey isoley 2.jpg",
                        "images/protein whey isoley 3.jpg"
                    ],
                    description: "پروتئین وی ایزوله با کیفیت بالا از برند معروف اپتیموم نوتریشن. این محصول حاوی 25 گرم پروتئین خالص در هر سروینگ بوده و فاقد لاکتوز و چربی است. مناسب برای ورزشکاران و بدنسازانی که به دنبال ترمیم و رشد عضلات هستند.",
                    flavors: ["شکلاتی", "وانیلی", "توت فرنگی"],
                    reviews: [
                        {user: "محمد حسینی", rating: 5, text: "محصول بسیار با کیفیتی هست. طعم شکلاتی عالی داره و به راحتی در آب حل میشه. بعد از یک ماه استفاده تاثیرش رو روی عضلاتم دیدم."},
                        {user: "علی محمدی", rating: 4, text: "کیفیت خوبی داره ولی قیمتش کمی بالاست. طعمش خوبه و ب��فت عضلاتم رو بهبود داده."}
                    ]
                },
                {
                    id: 2,
                    name: "کراتین مونوهیدرات ماسل تک 300 گرمی",
                    price: 1200000,
                    category: "کراتین",
                    brand: "MuscleTech",
                    images: [
                        "https://via.placeholder.com/300/FF0000/FFFFFF?text=Product+2",
                        "https://via.placeholder.com/300/00FF00/FFFFFF?text=Product+2"
                    ],
                    description: "کراتین مونوهیدرات خالص برای افزایش قدرت و حجم عضلات. مناسب برای ورزشکاران حرفه ای. هر سروینگ حاوی 5 گرم کراتین مونوهیدرات خالص است که به افزایش قدرت و استقامت در تمرینات کمک می کند.",
                    flavors: ["بدون طعم"],
                    reviews: [
                        {user: "رضا احمدی", rating: 5, text: "بعد از یک ماه استفاده واقعا تاثیرش رو دیدم. قدرت عضلاتم به شکل محسوسی افزایش پیدا کرده."}
                    ]
                },
                {
                    id: 3,
                    name: "گینر سریع جذب بی اس ان 5 کیلویی",
                    price: 4800000,
                    category: "گینر",
                    brand: "BSN",
                    images: [
                        "https://via.placeholder.com/300/FF0000/FFFFFF?text=Product+3",
                        "https://via.placeholder.com/300/00FF00/FFFFFF?text=Product+3",
                        "https://via.placeholder.com/300/0000FF/FFFFFF?text=Product+3"
                    ],
                    description: "گینر با کیفیت برای افزایش وزن و حجم عضلات. حاوی پروتئین و کربوهیدرات با کیفیت. این محصول با ترکیب مناسبی از پروتئین، کربوهیدرات و کالری به افزایش وزن و حجم عضلات کمک می کند.",
                    flavors: ["شکلاتی", "وانیلی"],
                    reviews: []
                },
                {
                    id: 4,
                    name: "پری ورک اوت سلوکور 300 گرمی",
                    price: 1500000,
                    category: "پری ورک اوت",
                    brand: "Cellucor",
                    images: [
                        "https://via.placeholder.com/300/FF0000/FFFFFF?text=Product+4"
                    ],
                    description: "مکمل قبل از تمرین برای افزایش انرژی و تمرکز حین ورزش. این محصول حاوی ترکیباتی مانند کافئین، بتاآلانین و سیترولین است که به افزایش انرژی، استقامت و پمپاژ خون در عضلات کمک می کند.",
                    flavors: ["آبی", "قرمز"],
                    reviews: [
                        {user: "سارا محمدی", rating: 4, text: "انرژی خیلی خوبی میده ولی نباید عصرها مصرف بشه چون ممکنه باعث بی خوابی بشه."}
                    ]
                },
                {
                    id: 5,
                    name: "آمینو انرجی اپتیموم نوتریشن 375 گرمی",
                    price: 2300000,
                    category: "آمینو اسید",
                    brand: "Optimum Nutrition",
                    images: [
                        "https://via.placeholder.com/300/FF0000/FFFFFF?text=Product+5",
                        "https://via.placeholder.com/300/00FF00/FFFFFF?text=Product+5"
                    ],
                    description: "آمینو اسیدهای ضروری برای ریکاوری سریع عضلات بعد از تمرین. این محصول حاوی ترکیبی از آمینو اسیدهای شاخه دار (BCAA) و سایر آمینو اسیدهای ضروری است که به ریکاوری و رشد عضلات کمک می کند.",
                    flavors: ["پرتقالی", "لیمویی"],
                    reviews: []
                },
                {
                    id: 6,
                    name: "چربی سوز هیدروکات ماسل تک 100 کپسول",
                    price: 2800000,
                    category: "چربی سوز",
                    brand: "MuscleTech",
                    images: [
                        "https://via.placeholder.com/300/FF0000/FFFFFF?text=Product+6"
                    ],
                    description: "چربی سوز قوی برای کاهش چربی های بدن و افزایش متابولیسم. این محصول با ترکیباتی مانند کافئین، ال-کارنیتین و عصاره چای سبز به افزایش چربی سوزی و کاهش وزن کمک می کند.",
                    flavors: [],
                    reviews: [
                        {user: "نازنین کریمی", rating: 3, text: "اثرش خوبه ولی گاهی باعث تپش قلب میشه. بهتره با دوز کم شروع بشه."}
                    ]
                },
                {
                    id: 7,
                    name: "پروتئین کازیین اپتیموم نوتریشن 2 کیلویی",
                    price: 3800000,
                    category: "پروتئین",
                    brand: "Optimum Nutrition",
                    images: [
                        "https://via.placeholder.com/300/FF0000/FFFFFF?text=Product+7",
                        "https://via.placeholder.com/300/00FF00/FFFFFF?text=Product+7"
                    ],
                    description: "پروتئین کازیین با جذب آهسته، مناسب برای مصرف قبل از خواب. این محصول حاوی 24 گرم پروتئین در هر سروینگ است و به ترمیم عضلات در طول شب کمک می کند.",
                    flavors: ["شکلاتی", "وانیلی"],
                    reviews: []
                },
                {
                    id: 8,
                    name: "گلوتامین ماسل تک 300 گرمی",
                    price: 1500000,
                    category: "آمینو اسید",
                    brand: "MuscleTech",
                    images: [
                        "https://via.placeholder.com/300/FF0000/FFFFFF?text=Product+8"
                    ],
                    description: "گلوتامین خالص برای ریکاوری سریع عضلات و تقویت سیستم ایمنی. هر سروینگ حاوی 5 گرم گلوتامین است که به کاهش خستگی عضلات و بهبود ریکاوری کمک می کند.",
                    flavors: ["بدون طعم"],
                    reviews: []
                }
            ],
            categories: [
                "همه محصولات",
                "پروتئین",
                "گینر",
                "کراتین",
                "پری ورک اوت",
                "آمینو اسید",
                "چربی سوز"
            ],
            selectedCategory: "همه محصولات",
            searchQuery: "",
            minPrice: 0,
            maxPrice: 10000000,
            editingProfileField: null,
            selectedFlavor: null,
            deliveryMethod: {
                type: "پست پیشتاز",
                price: 50000
            },
            deliveryTime: {
                time: "9 صبح تا 12 ظهر",
                extraPrice: 0
            },
            paymentMethod: "آنلاین",
            pageHistory: ['home'],
            pendingOrder: null,
            currentProductReview: {
                rating: 0,
                text: ""
            }
        };

        // DOM Elements
        const homePage = document.getElementById('home-page');
        const productDetailPage = document.getElementById('product-detail-page');
        const cartPage = document.getElementById('cart-page');
        const checkoutPage = document.getElementById('checkout-page');
        const ordersPage = document.getElementById('orders-page');
        const profilePage = document.getElementById('profile-page');
        
        const navItems = document.querySelectorAll('.nav-item');
        const navHome = document.getElementById('nav-home');
        const navCart = document.getElementById('nav-cart');
        const navOrders = document.getElementById('nav-orders');
        const navProfile = document.getElementById('nav-profile');
        
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const supportBtn = document.getElementById('support-btn');
        const toastMessage = document.getElementById('toast-message');
        const cartCount = document.getElementById('cart-count');
        
        const categoriesContainer = document.getElementById('categories-container');
        const productsContainer = document.getElementById('products-container');
        const cartContainer = document.getElementById('cart-container');
        const checkoutContainer = document.getElementById('checkout-container');
        const ordersContainer = document.getElementById('orders-container');
        const profileContainer = document.getElementById('profile-container');
        const filtersContainer = document.getElementById('filters-container');
        
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const loginFields = document.getElementById('login-fields');
        const registerFields = document.getElementById('register-fields');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authSwitchBtn = document.getElementById('auth-switch-btn');
        const authSwitchText = document.getElementById('auth-switch-text');
        const closeAuthModal = document.getElementById('close-auth-modal');
        const loginPasswordInput = document.getElementById('login-password');
        const registerPasswordInput = document.getElementById('register-password');
        const loginPasswordToggle = document.getElementById('login-password-toggle');
        const registerPasswordToggle = document.getElementById('register-password-toggle');
        
        const paymentModal = document.getElementById('payment-modal');
        const closePaymentModal = document.getElementById('close-payment-modal');
        const confirmPaymentBtn = document.getElementById('confirm-payment');
        const cancelPaymentBtn = document.getElementById('cancel-payment');
        const cardNumberInput = document.getElementById('card-number');
        const cardExpiryInput = document.getElementById('card-expiry');
        const cardCvvInput = document.getElementById('card-cvv');
        
        const zoomModal = document.getElementById('zoom-modal');
        const zoomedImage = document.getElementById('zoomed-image');
        const closeZoom = document.getElementById('close-zoom');
        
        const avatarModal = document.getElementById('avatar-modal');
        const closeAvatarModal = document.getElementById('close-avatar-modal');
        const avatarInput = document.getElementById('avatar-input');
        const selectAvatarBtn = document.getElementById('select-avatar-btn');
        const saveAvatarBtn = document.getElementById('save-avatar-btn');
        const avatarPreviewContainer = document.getElementById('avatar-preview-container');
        const avatarPreview = document.getElementById('avatar-preview');
        
        const minPriceInput = document.getElementById('min-price');
        const maxPriceInput = document.getElementById('max-price');
        const priceRange = document.querySelector('.price-range');
        const footer = document.querySelector('footer');

        // Initialize the app
        function init() {
            // Load users data from localStorage if exists
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                state.users = JSON.parse(savedUsers);
                
                // در تابع init
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                darkModeToggle.addEventListener('change', () => {
                    document.body.setAttribute('data-theme', 
                        darkModeToggle.checked ? 'dark' : 'light');
                    localStorage.setItem('darkMode', darkModeToggle.checked);
                });
                
                // بارگذاری حالت ذخیره شده
                if (localStorage.getItem('darkMode') === 'true') {
                    darkModeToggle.checked = true;
                    document.body.setAttribute('data-theme', 'dark');
                }
                
                // Find the last active user
                const lastActiveUserIndex = state.users.findIndex(user => user.isActive);
                if (lastActiveUserIndex !== -1) {
                    state.currentUserIndex = lastActiveUserIndex;
                    state.isLoggedIn = true;
                    
                    // Load cart, wishlist, orders and pending order for the active user
                    const activeUser = state.users[state.currentUserIndex];
                    const savedCart = localStorage.getItem(`cart_${activeUser.phone}`);
                    const savedWishlist = localStorage.getItem(`wishlist_${activeUser.phone}`);
                    const savedOrders = localStorage.getItem(`orders_${activeUser.phone}`);
                    const savedPendingOrder = localStorage.getItem(`pendingOrder_${activeUser.phone}`);
                    
                    if (savedCart) state.cart = JSON.parse(savedCart);
                    if (savedWishlist) state.wishlist = JSON.parse(savedWishlist);
                    if (savedOrders) state.orders = JSON.parse(savedOrders);
                    if (savedPendingOrder) state.pendingOrder = JSON.parse(savedPendingOrder);
                }
            }
            
            renderCategories();
            renderProducts();
            updateAuthUI();
            updateCartCount();
            setupEventListeners();
            
            // Handle back button
            window.addEventListener('popstate', handleBackButton);
            
            // Show footer only on home page initially
            updateFooterVisibility();
        }

        // Get current user
        function getCurrentUser() {
            if (state.currentUserIndex === -1) return null;
            return state.users[state.currentUserIndex];
        }

        // Update footer visibility based on current page
        function updateFooterVisibility() {
            if (state.currentPage === 'home') {
                footer.style.display = 'block';
            } else {
                footer.style.display = 'none';
            }
        }

        // Handle back button
        function handleBackButton() {
            if (state.pageHistory.length > 1) {
                state.pageHistory.pop(); // Remove current page
                const prevPage = state.pageHistory.pop(); // Get previous page
                showPage(prevPage, false); // Don't add to history
            }
        }

        // Update cart count in navigation
        function updateCartCount() {
            if (state.isLoggedIn && state.cart.length > 0) {
                const totalItems = state.cart.reduce((total, item) => total + item.quantity, 0);
                cartCount.textContent = totalItems;
                cartCount.style.display = 'flex';
            } else {
                cartCount.style.display = 'none';
            }
        }

        // Render Categories
        function renderCategories() {
            categoriesContainer.innerHTML = '';
            state.categories.forEach(category => {
                const categoryEl = document.createElement('div');
                categoryEl.className = `category ${state.selectedCategory === category ? 'active' : ''}`;
                categoryEl.textContent = category;
                categoryEl.addEventListener('click', () => {
                    state.selectedCategory = category;
                    renderCategories();
                    renderProducts();
                });
                categoriesContainer.appendChild(categoryEl);
            });
        }

        // Render Products
        function renderProducts() {
            productsContainer.innerHTML = '';
            
            let filteredProducts = [...state.products];
            
            // فیلتر بر اساس دسته‌بندی
            if (state.selectedCategory !== 'همه محصولات') {
                filteredProducts = filteredProducts.filter(p => p.category === state.selectedCategory);
            }
            
            // فیلتر بر اساس جستجو
            if (state.searchQuery) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.includes(state.searchQuery) || 
                    p.brand.includes(state.searchQuery)
                );
            }
            
            // فیلتر بر اساس قیمت
            const minPrice = parseInt(minPriceInput.value) || 0;
            const maxPrice = parseInt(maxPriceInput.value) || 10000000;
            
            filteredProducts = filteredProducts.filter(p => p.price >= minPrice && p.price <= maxPrice);
            
            // فیلتر بر اساس برند
            const selectedBrand = document.querySelector('.brand-item.active')?.textContent;
            if (selectedBrand && selectedBrand !== 'همه') {
                filteredProducts = filteredProducts.filter(p => p.brand === selectedBrand);
            }
            
            // نمایش محصولات فیلترشده
            if (filteredProducts.length === 0) {
                productsContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1">
                        <i><i class="fas fa-search"></i></i>
                        <p>محصولی یافت نشد</p>
                    </div>
                `;
                return;
            }
            
            // نمایش محصولات
            filteredProducts.forEach(product => {
                const isInWishlist = state.wishlist.some(item => item.id === product.id);
                
                const productEl = document.createElement('div');
                productEl.className = 'product-card';
                productEl.innerHTML = `
                    <div class="product-image">
                        <img src="${product.images[0]}" alt="${product.name}">
                        ${product.price < 2000000 ? `<div class="product-badge">پرفروش</div>` : ''}
                        <div class="product-stock">موجود در انبار</div>
                    </div>
                    <div class="product-info">
                        <div class="product-title">${product.name}</div>
                        <div class="product-price">${product.price.toLocaleString()} تومان</div>
                        <div class="product-actions">
                            <button class="add-to-cart" data-id="${product.id}">افزودن به سبد</button>
                            <button class="add-to-wishlist ${isInWishlist ? 'active' : ''}" data-id="${product.id}">${isInWishlist ? '❤' : '♡'}</button>
                        </div>
                    </div>
                `;
                productEl.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('add-to-cart') && !e.target.classList.contains('add-to-wishlist')) {
                        showProductDetail(product.id);
                    }
                });
                productsContainer.appendChild(productEl);
            });
        }

        // Show Product Detail
        function showProductDetail(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            const isInWishlist = state.wishlist.some(item => item.id === product.id);
            state.selectedFlavor = null;
            state.currentProductReview = { rating: 0, text: "" };
            
            // Find recommended products (same category, different from current product)
            const recommendedProducts = state.products.filter(p => 
                p.category === product.category && 
                p.id !== product.id
            ).slice(0, 4); // Show max 4 recommended products
            
            productDetailPage.innerHTML = `
                <div class="product-detail">
                    <div class="detail-header">
                        <div class="main-image-container">
                            <img src="${product.images[0]}" alt="${product.name}">
                            <div class="zoom-icon"><i class="fas fa-search"></i></div>
                        </div>
                        <div class="product-gallery">
                            ${product.images.map((img, index) => `
                                <img src="${img}" alt="${product.name} - ${index + 1}" class="${index === 0 ? 'active' : ''}">
                            `).join('')}
                        </div>
                        <div class="detail-info">
                            <h1 class="detail-title">${product.name}</h1>
                            <div class="detail-price">${product.price.toLocaleString()} تومان</div>
                            <div class="detail-description">${product.description}</div>
                            
                            <div class="product-rating">
                                ★★★★☆ <span>(12 نظر)</span>
                            </div>
                            
                            ${product.flavors.length > 0 ? `
                            <div class="flavors">
                                <span>طعم‌ها:</span>
                                ${product.flavors.map(flavor => `
                                    <div class="flavor ${state.selectedFlavor === flavor ? 'active' : ''}" data-flavor="${flavor}">${flavor}</div>
                                `).join('')}
                            </div>
                            ${state.selectedFlavor ? `<div class="selected-flavor">طعم انتخاب شده: ${state.selectedFlavor}</div>` : ''}
                            ` : ''}
                            
                            <div class="detail-actions">
                                <button class="detail-add-to-cart" data-id="${product.id}">
                                    <span>افزودن به سبد خرید</span>
                                </button>
                                <button class="detail-add-to-wishlist ${isInWishlist ? 'active' : ''}" data-id="${product.id}">
                                    ${isInWishlist ? '❤ حذف از علاقه‌مندی‌ها' : '♡ افزودن به علاقه‌مندی‌ها'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="review-form">
                    <h4>ثبت نظر شما</h4>
                    <div class="rating-stars" id="rating-stars">
                        <span data-rating="1">☆</span>
                        <span data-rating="2">☆</span>
                        <span data-rating="3">☆</span>
                        <span data-rating="4">☆</span>
                        <span data-rating="5">☆</span>
                    </div>
                    <textarea class="review-textarea" id="review-text" placeholder="نظر خود را درباره این محصول بنویسید..."></textarea>
                    <button class="submit-review" id="submit-review">ثبت نظر</button>
                </div>
                
                ${recommendedProducts.length > 0 ? `
                <div class="recommended-products">
                    <h3 class="recommended-title">محصولات مشابه</h3>
                    <div class="products">
                        ${recommendedProducts.map(recProduct => {
                            const isRecInWishlist = state.wishlist.some(item => item.id === recProduct.id);
                            return `
                                <div class="product-card">
                                    <div class="product-image">
                                        <img src="${recProduct.images[0]}" alt="${recProduct.name}">
                                    </div>
                                    <div class="product-info">
                                        <div class="product-title">${recProduct.name}</div>
                                        <div class="product-price">${recProduct.price.toLocaleString()} تومان</div>
                                        <div class="product-actions">
                                            <button class="add-to-cart" data-id="${recProduct.id}">افزودن به سبد</button>
                                            <button class="add-to-wishlist ${isRecInWishlist ? 'active' : ''}" data-id="${recProduct.id}">${isRecInWishlist ? '❤' : '♡'}</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${product.reviews.length > 0 ? `
                <div class="reviews">
                    <h3 class="reviews-title">نظرات کاربران</h3>
                    ${product.reviews.map(review => `
                    <div class="review-rating">
                    ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                    </div>
                            <div class="review-text">${review.text}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;
            
            // Set up gallery image click events
            const mainImage = document.querySelector('.main-image-container img');
            const galleryImages = document.querySelectorAll('.product-gallery img');
            
            galleryImages.forEach(img => {
                img.addEventListener('click', () => {
                    // Update main image
                    mainImage.src = img.src;
                    
                    // Update active state
                    galleryImages.forEach(i => i.classList.remove('active'));
                    img.classList.add('active');
                });
            });
            
            // Set up zoom icon click
            document.querySelector('.zoom-icon').addEventListener('click', () => {
                const activeImg = document.querySelector('.product-gallery img.active');
                if (activeImg) {
                    zoomedImage.src = activeImg.src;
                    zoomModal.classList.add('active');
                }
            });
            
            // Set up rating stars
            const stars = document.querySelectorAll('#rating-stars span');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.getAttribute('data-rating'));
                    state.currentProductReview.rating = rating;
                    
                    stars.forEach((s, index) => {
                        if (index < rating) {
                            s.textContent = '★';
                        } else {
                            s.textContent = '☆';
                        }
                    });
                });
            });
            
            // Set up review submission
            document.getElementById('submit-review').addEventListener('click', () => {
                const reviewText = document.getElementById('review-text').value.trim();
                
                if (!state.isLoggedIn) {
                    showToast('لطفا ابتدا وارد حساب کاربری خود شوید');
                    showAuthModal('login');
                    return;
                }
                
                if (state.currentProductReview.rating === 0) {
                    showToast('لطفا به محصول امتیاز دهید', 'error');
                    return;
                }
                
                if (reviewText.length < 10) {
                    showToast('نظر شما باید حداقل 10 کاراکتر داشته باشد', 'error');
                    return;
                }
                
                const currentUser = getCurrentUser();
                const newReview = {
                    user: currentUser.name,
                    rating: state.currentProductReview.rating,
                    text: reviewText
                };
                
                product.reviews.unshift(newReview);
                showToast('نظر شما با موفقیت ثبت شد', 'success');
                
                // Reset form
                state.currentProductReview = { rating: 0, text: "" };
                stars.forEach(star => star.textContent = '☆');
                document.getElementById('review-text').value = '';
                
                // Re-render reviews section
                showProductDetail(productId);
            });
            
            // اضافه کردن event listener برای دکمه‌های صفحه جزئیات
            document.querySelector('.detail-add-to-cart')?.addEventListener('click', () => {
                addToCart(product.id);
            });
            
            document.querySelector('.detail-add-to-wishlist')?.addEventListener('click', () => {
                addToWishlist(product.id);
            });
            
            // اضافه کردن event listener برای طعم‌ها
            document.querySelectorAll('.flavor').forEach(flavorEl => {
                flavorEl.addEventListener('click', () => {
                    state.selectedFlavor = flavorEl.getAttribute('data-flavor');
                    document.querySelectorAll('.flavor').forEach(f => f.classList.remove('active'));
                    flavorEl.classList.add('active');
                    
                    const selectedFlavorEl = document.querySelector('.selected-flavor');
                    if (selectedFlavorEl) {
                        selectedFlavorEl.textContent = `طعم انتخاب شده: ${state.selectedFlavor}`;
                    } else if (product.flavors.length > 0) {
                        const flavorsContainer = document.querySelector('.flavors');
                        const selectedDiv = document.createElement('div');
                        selectedDiv.className = 'selected-flavor';
                        selectedDiv.textContent = `طعم انتخاب شده: ${state.selectedFlavor}`;
                        flavorsContainer.parentNode.insertBefore(selectedDiv, flavorsContainer.nextSibling);
                    }
                });
            });
            
            // اضافه کردن event listener برای محصولات پیشنهادی
            document.querySelectorAll('.recommended-products .add-to-cart').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const recProductId = parseInt(btn.getAttribute('data-id'));
                    addToCart(recProductId);
                });
            });
            
            document.querySelectorAll('.recommended-products .add-to-wishlist').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const recProductId = parseInt(btn.getAttribute('data-id'));
                    addToWishlist(recProductId);
                });
            });
            
            document.querySelectorAll('.recommended-products .product-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('add-to-cart') && !e.target.classList.contains('add-to-wishlist')) {
                        const recProductId = parseInt(card.querySelector('.add-to-cart').getAttribute('data-id'));
                        showProductDetail(recProductId);
                    }
                });
            });
            
            showPage('product-detail');
        }

        // Render Cart
        function renderCart() {
            if (state.cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-state">
                        <i><i class="fas fa-shopping-cart"></i></i>
                        <p>سبد خرید شما خالی است</p>
                    </div>
                `;
                return;
            }
            
            let cartHTML = '';
            let total = 0;
            
            state.cart.forEach(item => {
                const product = state.products.find(p => p.id === item.id);
                const itemTotal = product.price * item.quantity;
                total += itemTotal;
                
                cartHTML += `
                    <div class="cart-item" data-id="${item.id}">
                        <div class="cart-item-image">
                            <img src="${product.images[0]}" alt="${product.name}">
                        </div>
                        <div class="cart-item-info">
                            <div class="cart-item-title">${product.name}</div>
                            ${item.flavor ? `<div class="cart-item-flavor">طعم: ${item.flavor}</div>` : ''}
                            <div class="cart-item-price">${product.price.toLocaleString()} تومان</div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn minus">-</button>
                            <span class="quantity-value">${item.quantity}</span>
                            <button class="quantity-btn plus">+</button>
                        </div>
                        <button class="cart-item-remove">×</button>
                    </div>
                `;
            });
            
            cartHTML += `
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>جمع کل:</span>
                        <span>${total.toLocaleString()} تومان</span>
                    </div>
                    <div class="summary-row">
                        <span>تخفیف:</span>
                        <span>0 تومان</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>مبلغ قابل پرداخت:</span>
                        <span>${total.toLocaleString()} تومان</span>
                    </div>
                    <button class="checkout-btn">تکمیل سفارش</button>
                </div>
            `;
            
            cartContainer.innerHTML = cartHTML;
        }

        // Render Checkout
        function renderCheckout() {
            if (state.cart.length === 0 && !state.pendingOrder) {
                showToast('سبد خرید شما خالی است');
                showPage('cart');
                return;
            }
            
            // Use cart items or pending order items
            const items = state.pendingOrder ? state.pendingOrder.items : state.cart;
            
            // Calculate total
            let total = 0;
            items.forEach(item => {
                const product = state.products.find(p => p.id === item.id);
                total += product.price * item.quantity;
            });
            
            const deliveryPrice = state.pendingOrder ? state.pendingOrder.deliveryMethod.price : state.deliveryMethod.price;
            const timeExtra = state.pendingOrder ? state.pendingOrder.deliveryTime.extraPrice : state.deliveryTime.extraPrice;
            const finalTotal = total + deliveryPrice + timeExtra;
            
            checkoutContainer.innerHTML = `
                <div class="delivery-methods">
                    <h3 class="section-title">روش ارسال</h3>
                    <div class="method-item ${state.pendingOrder ? state.pendingOrder.deliveryMethod.type === 'پست پیشتاز' ? 'active' : '' : state.deliveryMethod.type === 'پست پیشتاز' ? 'active' : ''}" data-type="پست پیشتاز" data-price="50000">
                        <div class="method-info">
                            <div class="method-title">پست پیشتاز</div>
                            <div class="method-desc">تحویل 2-3 روز کاری</div>
                        </div>
                        <div class="method-price">50,000 تومان</div>
                    </div>
                    <div class="method-item ${state.pendingOrder ? state.pendingOrder.deliveryMethod.type === 'تیپاکس' ? 'active' : '' : state.deliveryMethod.type === 'تیپاکس' ? 'active' : ''}" data-type="تیپاکس" data-price="80000">
                        <div class="method-info">
                            <div class="method-title">تیپاکس</div>
                            <div class="method-desc">تحویل 1-2 روز کاری</div>
                        </div>
                        <div class="method-price">80,000 تومان</div>
                    </div>
                    <div class="method-item ${state.pendingOrder ? state.pendingOrder.deliveryMethod.type === 'پیک موتوری' ? 'active' : '' : state.deliveryMethod.type === 'پیک موتوری' ? 'active' : ''}" data-type="پیک موتوری" data-price="100000">
                        <div class="method-info">
                            <div class="method-title">پیک موتوری</div>
                            <div class="method-desc">تحویل در همان روز (ساری)</div>
                        </div>
                        <div class="method-price">100,000 تومان</div>
                    </div>
                </div>
                
                <div class="delivery-times">
                    <h3 class="section-title">زمان تحویل</h3>
                    <div class="time-item ${state.pendingOrder ? state.pendingOrder.deliveryTime.time === '9 صبح تا 12 ظهر' ? 'active' : '' : state.deliveryTime.time === '9 صبح تا 12 ظهر' ? 'active' : ''}" data-time="9 صبح تا 12 ظهر" data-price="0">
                        <div class="time-info">
                            <div class="time-title">9 صبح تا 12 ظهر</div>
                        </div>
                        <div class="time-value">+0 تومان</div>
                    </div>
                    <div class="time-item ${state.pendingOrder ? state.pendingOrder.deliveryTime.time === '12 ظهر تا 4 بعدازظهر' ? 'active' : '' : state.deliveryTime.time === '12 ظهر تا 4 بعدازظهر' ? 'active' : ''}" data-time="12 ظهر تا 4 بعدازظهر" data-price="0">
                        <div class="method-info">
                            <div class="method-title">12 ظهر تا 4 بعدازظهر</div>
                        </div>
                        <div class="time-value">+0 تومان</div>
                    </div>
                    <div class="time-item ${state.pendingOrder ? state.pendingOrder.deliveryTime.time === '4 بعدازظهر تا 8 شب' ? 'active' : '' : state.deliveryTime.time === '4 بعدازظهر تا 8 شب' ? 'active' : ''}" data-time="4 بعدازظهر تا 8 شب" data-price="20000">
                        <div class="time-info">
                            <div class="time-title">4 بعدازظهر تا 8 شب</div>
                        </div>
                        <div class="time-value">+20,000 تومان</div>
                    </div>
                </div>
                
                <div class="payment-methods">
                    <h3 class="section-title">روش پرداخت</h3>
                    <div class="payment-item ${state.pendingOrder ? state.pendingOrder.paymentMethod === 'آنلاین' ? 'active' : '' : state.paymentMethod === 'آنلاین' ? 'active' : ''}" data-method="آنلاین">
                        <div class="payment-info">
                            <div class="payment-title">پرداخت آنلاین</div>
                            <div class="payment-desc">پرداخت از طریق درگاه بانکی</div>
                        </div>
                        <div class="payment-price">+0 تومان</div>
                    </div>
                    <div class="payment-item ${state.pendingOrder ? state.pendingOrder.paymentMethod === 'در محل' ? 'active' : '' : state.paymentMethod === 'در محل' ? 'active' : ''}" data-method="در محل">
                        <div class="payment-info">
                            <div class="payment-title">پرداخت در محل</div>
                            <div class="payment-desc">پرداخت هنگام دریافت سفارش</div>
                        </div>
                        <div class="payment-price">+0 تومان</div>
                    </div>
                </div>
                
                <div class="summary-row">
                    <span>جمع محصولات:</span>
                    <span>${total.toLocaleString()} تومان</span>
                </div>
                <div class="summary-row">
                    <span>هزینه ارسال:</span>
                    <span>${deliveryPrice.toLocaleString()} تومان</span>
                </div>
                ${timeExtra > 0 ? `
                <div class="summary-row">
                    <span>هزینه زمان تحویل:</span>
                    <span>${timeExtra.toLocaleString()} تومان</span>
                </div>
                ` : ''}
                <div class="summary-row summary-total" style="margin: 20px 0;">
                    <span>مبلغ قابل پرداخت:</span>
                    <span>${finalTotal.toLocaleString()} تومان</span>
                </div>
                
                <button class="payment-btn">${state.pendingOrder ? state.pendingOrder.paymentMethod === 'آنلاین' ? 'پرداخت آنلاین' : 'تکمیل سفارش' : state.paymentMethod === 'آنلاین' ? 'پرداخت آنلاین' : 'تکمیل سفارش'}</button>
            `;
            
            showPage('checkout');
        }

        // Render Orders
        function renderOrders() {
            if (state.orders.length === 0 && !state.pendingOrder) {
                ordersContainer.innerHTML = `
                    <div class="empty-state">
                        <i><i class="fas fa-box"></i></i>
                        <p>سفارشی ثبت نشده است</p>
                    </div>
                `;
                return;
            }
            
            let ordersHTML = '';
            
            // Show pending order first if exists
            if (state.pendingOrder) {
                let orderTotal = 0;
                let productsHTML = '';
                
                state.pendingOrder.items.forEach(item => {
                    const product = state.products.find(p => p.id === item.id);
                    orderTotal += product.price * item.quantity;
                    productsHTML += `
                        <div class="order-product">
                            <div class="order-product-name">${product.name}</div>
                            ${item.flavor ? `<div class="order-product-flavor">${item.flavor}</div>` : ''}
                            <div class="order-product-quantity">${item.quantity} عدد</div>
                        </div>
                    `;
                });
                
                ordersHTML += `
                    <div class="order-item" data-id="${state.pendingOrder.id}">
                        <div class="order-header">
                            <div class="order-id">شماره سفارش: #${state.pendingOrder.id}</div>
                            <div class="order-date">${state.pendingOrder.date}</div>
                            <div class="order-status pending">${state.pendingOrder.status}</div>
                        </div>
                        <div class="order-products">
                            ${productsHTML}
                        </div>
                        <div class="order-summary">
                            <div class="order-total">مبلغ کل: ${orderTotal.toLocaleString()} تومان</div>
                        </div>
                    </div>
                `;
            }
            
            // Show completed orders
            state.orders.forEach(order => {
                let orderTotal = 0;
                let productsHTML = '';
                
                order.items.forEach(item => {
                    const product = state.products.find(p => p.id === item.id);
                    orderTotal += product.price * item.quantity;
                    productsHTML += `
                        <div class="order-product">
                            <div class="order-product-name">${product.name}</div>
                            ${item.flavor ? `<div class="order-product-flavor">${item.flavor}</div>` : ''}
                            <div class="order-product-quantity">${item.quantity} عدد</div>
                        </div>
                    `;
                });
                
                ordersHTML += `
                    <div class="order-item" data-id="${order.id}">
                        <div class="order-header">
                            <div class="order-id">شماره سفارش: #${order.id}</div>
                            <div class="order-date">${order.date}</div>
                            <div class="order-status ${order.status === 'در انتظار پرداخت' ? 'pending' : 'completed'}">${order.status}</div>
                        </div>
                        <div class="order-products">
                            ${productsHTML}
                        </div>
                        <div class="order-summary">
                            <div class="order-total">مبلغ کل: ${orderTotal.toLocaleString()} تومان</div>
                        </div>
                    </div>
                `;
            });
            
            ordersContainer.innerHTML = ordersHTML;
        }

        // Render Profile
        function renderProfile() {
            const currentUser = getCurrentUser();
            
            if (!currentUser) {
                profileContainer.innerHTML = `
                    <div class="empty-state">
                        <i><i class="fas fa-user"></i></i>
                        <p>لطفا وارد حساب کاربری خود شوید</p>
                    </div>
                `;
                return;
            }
        
            
            let profileHTML = `
                <div class="profile-header">
                    <div class="profile-avatar">
                        ${currentUser.avatar ? `<img src="${currentUser.avatar}" alt="${currentUser.name}">` : `<i><i class="fas fa-user"></i></i>`}
                        <div class="add-avatar-btn" id="add-avatar-btn">+</div>
                    </div>
                    <div class="profile-name">
                        <h3 id="account-switcher">${currentUser.name} <i>▼</i></h3>
                        <p>${currentUser.phone}</p>
                        <div class="account-dropdown" id="account-dropdown">
                            ${state.users.map((user, index) => `
                                <div class="account-item ${state.currentUserIndex === index ? 'active' : ''}" data-index="${index}">
                                    <span>${user.name}</span>
                                    <i>${state.currentUserIndex === index ? '✓' : ''}</i>
                                </div>
                            `).join('')}
                            <div class="account-item add-account" id="add-account">
                                <span>افزودن حساب جدید</span>
                                <i>+</i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-menu">
                    <div class="profile-menu-item ${state.currentProfileTab === 'account' ? 'active' : ''}" data-tab="account">
                        <i><i class="fas fa-user"></i></i>
                        <span>حساب کاربری</span>
                    </div>
                    <div class="profile-menu-item ${state.currentProfileTab === 'wishlist' ? 'active' : ''}" data-tab="wishlist">
                        <i>❤</i>
                        <span>لیست علاقه‌مندی‌ها</span>
                    </div>
                    <div class="profile-menu-item" id="logout-btn">
                        <i>🚪</i>
                        <span>خروج از حساب</span>
                    </div>
                </div>
                
                <div class="profile-content">
            `;
            
            if (state.currentProfileTab === 'account') {
                profileHTML += `
                    <div class="user-info">
                        <div class="info-row">
                            <div class="info-label">نام کامل:</div>
                            <div class="info-value">
                                ${state.editingProfileField === 'name' ? `
                                    <input type="text" class="edit-input" value="${currentUser.name}" id="edit-name">
                                    <button class="save-btn" data-field="name">ذخیره</button>
                                ` : currentUser.name}
                                ${state.editingProfileField !== 'name' ? `
                                    <button class="edit-btn" data-field="name">ویرایش</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">کد ملی:</div>
                            <div class="info-value">${currentUser.nationalCode}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">شماره تماس:</div>
                            <div class="info-value">${currentUser.phone}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">ایمیل:</div>
                            <div class="info-value">
                                ${state.editingProfileField === 'email' ? `
                                    <input type="text" class="edit-input" value="${currentUser.email}" id="edit-email">
                                    <button class="save-btn" data-field="email">ذخیره</button>
                                ` : currentUser.email}
                                ${state.editingProfileField !== 'email' ? `
                                    <button class="edit-btn" data-field="email">ویرایش</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">آدرس:</div>
                            <div class="info-value">
                                ${state.editingProfileField === 'address' ? `
                                    <input type="text" class="edit-input" value="${currentUser.address}" id="edit-address">
                                    <button class="save-btn" data-field="address">ذخیره</button>
                                ` : currentUser.address}
                                ${state.editingProfileField !== 'address' ? `
                                    <button class="edit-btn" data-field="address">ویرایش</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.currentProfileTab === 'wishlist') {
                if (state.wishlist.length === 0) {
                    profileHTML += `
                        <div class="empty-state">
                            <i>❤</i>
                            <p>لیست علاقه‌مندی‌های شما خالی است</p>
                        </div>
                    `;
                } else {
                    profileHTML += '<div class="wishlist-items">';
                    
                    state.wishlist.forEach(product => {
                        profileHTML += `
                            <div class="wishlist-item" data-id="${product.id}">
                                <button class="wishlist-item-remove">×</button>
                                <div class="wishlist-item-image">
                                    <img src="${product.images[0]}" alt="${product.name}">
                                </div>
                                <div class="wishlist-item-title">${product.name}</div>
                                <div class="wishlist-item-price">${product.price.toLocaleString()} تومان</div>
                            </div>
                        `;
                    });
                    
                    profileHTML += '</div>';
                }
            }
            
            
            
            profileHTML += `</div>`;
            profileContainer.innerHTML = profileHTML;
            
            
        }

        // Show Page
        function showPage(page, addToHistory = true) {
            // Hide all pages
            homePage.style.display = 'none';
            productDetailPage.style.display = 'none';
            cartPage.style.display = 'none';
            checkoutPage.style.display = 'none';
            ordersPage.style.display = 'none';
            profilePage.style.display = 'none';
            
            // Hide filters on all pages except home
            filtersContainer.style.display = page === 'home' ? 'block' : 'none';
            
            // Update nav items
            navItems.forEach(item => item.classList.remove('active'));
            
            // Show selected page
            switch(page) {
                case 'home':
                    homePage.style.display = 'block';
                    navHome.classList.add('active');
                    state.currentPage = 'home';
                    renderProducts();
                    break;
                case 'product-detail':
                    productDetailPage.style.display = 'block';
                    navHome.classList.add('active');
                    state.currentPage = 'product-detail';
                    break;
                case 'cart':
                    if (state.isLoggedIn) {
                        cartPage.style.display = 'block';
                        navCart.classList.add('active');
                        state.currentPage = 'cart';
                        renderCart();
                    } else {
                        showToast('لطفا ابتدا وارد حساب کاربری خود شوید');
                        showAuthModal('login');
                    }
                    break;
                case 'checkout':
                    checkoutPage.style.display = 'block';
                    navCart.classList.add('active');
                    state.currentPage = 'checkout';
                    break;
                case 'orders':
                    if (state.isLoggedIn) {
                        ordersPage.style.display = 'block';
                        navOrders.classList.add('active');
                        state.currentPage = 'orders';
                        renderOrders();
                    } else {
                        showToast('لطفا ابتدا وارد حساب کاربری خود شوید');
                        showAuthModal('login');
                    }
                    break;
                case 'profile':
                    if (state.isLoggedIn) {
                        profilePage.style.display = 'block';
                        navProfile.classList.add('active');
                        state.currentPage = 'profile';
                        renderProfile();
                    } else {
                        showToast('لطفا ابتدا وارد حساب کاربری خود شوید');
                        showAuthModal('login');
                    }
                    break;
            }
            
            // Update footer visibility
            updateFooterVisibility();
            
            // Add to page history
            if (addToHistory && state.pageHistory[state.pageHistory.length - 1] !== page) {
                state.pageHistory.push(page);
                window.history.pushState({ page }, '', `#${page}`);
            }
        }

        // Show Auth Modal
        function showAuthModal(type) {
            if (type === 'login') {
                authModalTitle.textContent = 'ورود به حساب کاربری';
                loginFields.style.display = 'block';
                registerFields.style.display = 'none';
                authSubmitBtn.textContent = 'ورود';
                authSwitchText.textContent = 'حساب کاربری ندارید؟';
                authSwitchBtn.textContent = 'ثبت نام';
            } else {
                authModalTitle.textContent = 'ثبت نام';
                loginFields.style.display = 'none';
                registerFields.style.display = 'block';
                authSubmitBtn.textContent = 'ثبت نام';
                authSwitchText.textContent = 'قبلا ثبت نام کرده‌اید؟';
                authSwitchBtn.textContent = 'ورود';
            }
            
            authModal.classList.add('active');
        }

        // Hide Auth Modal
        function hideAuthModal() {
            authModal.classList.remove('active');
        }

        // Show Payment Modal
        function showPaymentModal() {
            paymentModal.classList.add('active');
        }

        // Hide Payment Modal
        function hidePaymentModal() {
            paymentModal.classList.remove('active');
        }

        // Show Zoom Modal
        function showZoomModal(imageSrc) {
            zoomedImage.src = imageSrc;
            zoomModal.classList.add('active');
        }

        // Hide Zoom Modal
        function hideZoomModal() {
            zoomModal.classList.remove('active');
        }

        // Show Avatar Modal
        function showAvatarModal() {
            avatarModal.classList.add('active');
        }

        // Hide Avatar Modal
        function hideAvatarModal() {
            avatarModal.classList.remove('active');
        }

        // Update Auth UI
        function updateAuthUI() {
            if (state.isLoggedIn) {
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
            } else {
                loginBtn.style.display = 'block';
                registerBtn.style.display = 'block';
            }
        }

        // Show Toast Message
        function showToast(message, type = 'info') {
            toastMessage.textContent = message;
            toastMessage.className = 'toast';
            toastMessage.classList.add(type);
            toastMessage.classList.add('show');
            
            setTimeout(() => {
                toastMessage.classList.remove('show');
            }, 3000);
        }

        // Add to Cart
        function addToCart(productId) {
            if (!state.isLoggedIn) {
                showToast('<i class="fas fa-shopping-cart"></i> لطفا ابتدا وارد حساب کاربری شوید', 'info');
                showAuthModal('login');
                return;
            }
            
            const product = state.products.find(p => p.id === productId);
            
            const existingItem = state.cart.find(item => item.id === productId && item.flavor === state.selectedFlavor);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                state.cart.push({
                    id: productId,
                    quantity: 1,
                    flavor: state.selectedFlavor
                });
            }
            
            // Save cart to localStorage
            const currentUser = getCurrentUser();
            if (currentUser) {
                localStorage.setItem(`cart_${currentUser.phone}`, JSON.stringify(state.cart));
            }
            
            showToast(`✅ "${product.name}" ${state.selectedFlavor ? `(طعم ${state.selectedFlavor}) ` : ''}به سبد اضافه شد`, 'success');
            updateCartCount();
            
            if (state.currentPage === 'cart') {
                renderCart();
            }
        }

        // Remove from Cart
        function removeFromCart(productId) {
            state.cart = state.cart.filter(item => item.id !== productId);
            
            // Save cart to localStorage
            const currentUser = getCurrentUser();
            if (currentUser) {
                localStorage.setItem(`cart_${currentUser.phone}`, JSON.stringify(state.cart));
            }
            
            updateCartCount();
            renderCart();
            showToast('محصول از سبد خرید حذف شد');
        }

        // Update Cart Item Quantity
        function updateCartItemQuantity(productId, change) {
            const item = state.cart.find(item => item.id === productId);
            
            if (item) {
                item.quantity += change;
                
                if (item.quantity < 1) {
                    removeFromCart(productId);
                } else {
                    // Save cart to localStorage
                    const currentUser = getCurrentUser();
                    if (currentUser) {
                        localStorage.setItem(`cart_${currentUser.phone}`, JSON.stringify(state.cart));
                    }
                    updateCartCount();
                    renderCart();
                }
            }
        }

        // Add to Wishlist
        function addToWishlist(productId) {
            if (!state.isLoggedIn) {
                showToast('لط��ا ابتدا وارد حساب کاربری خود شوید');
                showAuthModal('login');
                return;
            }
            
            const product = state.products.find(p => p.id === productId);
            const isInWishlist = state.wishlist.some(item => item.id === productId);
            
            if (isInWishlist) {
                state.wishlist = state.wishlist.filter(item => item.id !== productId);
                showToast('محصول از لیست علاقه‌مندی‌ها حذف شد');
            } else {
                state.wishlist.push(product);
                showToast('محصول به لیست علاقه‌مندی‌ها اضافه شد');
            }
            
            // Save wishlist to localStorage
            const currentUser = getCurrentUser();
            if (currentUser) {
                localStorage.setItem(`wishlist_${currentUser.phone}`, JSON.stringify(state.wishlist));
            }
            
            if (state.currentPage === 'home' || state.currentPage === 'product-detail') {
                renderProducts();
            } else if (state.currentPage === 'profile' && state.currentProfileTab === 'wishlist') {
                renderProfile();
            }
        }

        // Checkout
        function checkout() {
            if (state.cart.length === 0) {
                showToast('سبد خرید شما خالی است');
                return;
            }
            
            renderCheckout();
        }

        // Complete Payment
        function completePayment() {
            if (state.cart.length === 0 && !state.pendingOrder) {
                showToast('سبد خرید شما خالی است');
                return;
            }
            
            // Create a new order or use pending order
            const newOrder = state.pendingOrder || {
                id: Date.now(),
                date: new Date().toLocaleDateString('fa-IR'),
                status: state.paymentMethod === 'آنلاین' ? 'در انتظار پرداخت' : 'ثبت شده',
                items: [...state.cart],
                deliveryMethod: state.deliveryMethod,
                deliveryTime: state.deliveryTime,
                paymentMethod: state.paymentMethod
            };
            
            if (state.paymentMethod === 'آنلاین') {
                // For online payment, save as pending order
                state.pendingOrder = newOrder;
                const currentUser = getCurrentUser();
                if (currentUser) {
                    localStorage.setItem(`pendingOrder_${currentUser.phone}`, JSON.stringify(state.pendingOrder));
                }
                showPaymentModal();
            } else {
                // For cash on delivery, complete the order
                state.orders.unshift(newOrder);
                
                if (!state.pendingOrder) {
                    // Only clear cart if this is a new order (not a pending one)
                    state.cart = [];
                    const currentUser = getCurrentUser();
                    if (currentUser) {
                        localStorage.setItem(`cart_${currentUser.phone}`, JSON.stringify([]));
                    }
                }
                
                // Clear pending order
                state.pendingOrder = null;
                const currentUser = getCurrentUser();
                if (currentUser) {
                    localStorage.removeItem(`pendingOrder_${currentUser.phone}`);
                }
                
                // Save orders to localStorage
                if (currentUser) {
                    localStorage.setItem(`orders_${currentUser.phone}`, JSON.stringify(state.orders));
                }
                
                showToast('سفارش شما با موفقیت ثبت شد', 'success');
                updateCartCount();
                showPage('orders');
            }
        }

        // Validate Payment Card
        function validatePaymentCard() {
            const cardNumber = cardNumberInput.value.trim();
            const cardExpiry = cardExpiryInput.value.trim();
            const cardCvv = cardCvvInput.value.trim();
            
            // Validate card number (16 digits)
            if (!/^\d{16}$/.test(cardNumber)) {
                showToast('شماره کارت باید 16 رقمی باشد', 'error');
                return false;
            }
            
            // Validate expiry date (MM/YY)
            if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                showToast('فرت تاریخ انقضا باید به صورت ماه/سال باشد (مثلا 12/25)', 'error');
                return false;
            }
            
            // Validate CVV (3 or 4 digits)
            if (!/^\d{3,4}$/.test(cardCvv)) {
                showToast('CVV باید 3 یا 4 رقم باشد', 'error');
                return false;
            }
            
            return true;
        }

        // Confirm Payment
        function confirmPayment() {
            if (!validatePaymentCard()) {
                return;
            }
            
            // In a real app, this would be an API call to process payment
            setTimeout(() => {
                hidePaymentModal();
                
                // Update order status
                if (state.pendingOrder) {
                    state.pendingOrder.status = 'ثبت شده';
                    state.orders.unshift(state.pendingOrder);
                    
                    const currentUser = getCurrentUser();
                    // Save updated orders to localStorage
                    if (currentUser) {
                        localStorage.setItem(`orders_${currentUser.phone}`, JSON.stringify(state.orders));
                        localStorage.removeItem(`pendingOrder_${currentUser.phone}`);
                    }
                    
                    // Clear cart and pending order
                    state.cart = [];
                    state.pendingOrder = null;
                    if (currentUser) {
                        localStorage.setItem(`cart_${currentUser.phone}`, JSON.stringify([]));
                    }
                    
                    showToast('پرداخت با موفقیت انجام شد و سفارش شما ثبت گردید', 'success');
                    updateCartCount();
                    showPage('orders');
                }
            }, 1500);
        }

        // Cancel Payment
        function cancelPayment() {
            hidePaymentModal();
            showToast('پرداخت لغو شد', 'error');
        }

        // Login
        function login(phone, password) {
            // In a real app, this would be an API call
            const userIndex = state.users.findIndex(user => user.phone === phone && user.password === password);
            
            if (userIndex !== -1) {
                // Mark all users as inactive
                state.users.forEach(user => user.isActive = false);
                
                // Mark the current user as active
                state.users[userIndex].isActive = true;
                state.currentUserIndex = userIndex;
                state.isLoggedIn = true;
                
                // Save users to localStorage
                localStorage.setItem('users', JSON.stringify(state.users));
                
                // Load saved cart, wishlist, orders and pending order from localStorage
                const currentUser = state.users[userIndex];
                const savedCart = localStorage.getItem(`cart_${currentUser.phone}`);
                const savedWishlist = localStorage.getItem(`wishlist_${currentUser.phone}`);
                const savedOrders = localStorage.getItem(`orders_${currentUser.phone}`);
                const savedPendingOrder = localStorage.getItem(`pendingOrder_${currentUser.phone}`);
                
                if (savedCart) state.cart = JSON.parse(savedCart);
                if (savedWishlist) state.wishlist = JSON.parse(savedWishlist);
                if (savedOrders) state.orders = JSON.parse(savedOrders);
                if (savedPendingOrder) state.pendingOrder = JSON.parse(savedPendingOrder);
                
                showToast('با موفقیت وارد شدید', 'success');
                updateAuthUI();
                updateCartCount();
                hideAuthModal();
                showPage('home');
                return true;
            }
            
            showToast('شماره تماس یا رمز عبور اشتباه است', 'error');
            return false;
        }

        // Register
        function register(userData) {
            // Check if phone or national code already exists
            const phoneExists = state.users.some(user => user.phone === userData.phone);
            const nationalExists = state.users.some(user => user.nationalCode === userData.nationalCode);
                    
            // اعتبارسنجی کد ملی
            if (!/^\d{10}$/.test(userData.nationalCode)) {
                showToast('کد ملی باید 10 رقمی باشد', 'error');
                return false;
            }
            
            // اعتبارسنجی شماره تماس
            if (!/^09\d{9}$/.test(userData.phone)) {
                showToast('شماره تماس باید با 09 شروع شده و 11 رقمی باشد', 'error');
                return false;
            }
            
            // اعتبارسنجی رمز عبور
            if (userData.password.length < 6) {
                showToast('رمز عبور باید حداقل 6 کاراکتر باشد', 'error');
                return false;
            }
            
            if (phoneExists) {
                showToast('این شماره تماس قبلا ثبت شده است', 'error');
                return false;
            }
            
            if (nationalExists) {
                showToast('این کد ملی قبلا ثبت شده است', 'error');
                return false;
            }
            
            // Create new user
            const newUser = {
                ...userData,
                isActive: true,
                avatar: null
            };
            
            // Mark all users as inactive
            state.users.forEach(user => user.isActive = false);
            
            // Add new user
            state.users.push(newUser);
            state.currentUserIndex = state.users.length - 1;
            state.isLoggedIn = true;
            
            // Initialize user data
            state.cart = [];
            state.wishlist = [];
            state.orders = [];
            state.pendingOrder = null;
            
            // Save users to localStorage
            localStorage.setItem('users', JSON.stringify(state.users));
            
            showToast('ثبت نام با موفقیت انجام شد', 'success');
            updateAuthUI();
            updateCartCount();
            hideAuthModal();
            showPage('home');
            return true;
        }

        // Logout
        function logout() {
            const currentUser = getCurrentUser();
            
            if (!currentUser) return;
            
            // Save current user's data
            localStorage.setItem(`cart_${currentUser.phone}`, JSON.stringify(state.cart));
            localStorage.setItem(`wishlist_${currentUser.phone}`, JSON.stringify(state.wishlist));
            localStorage.setItem(`orders_${currentUser.phone}`, JSON.stringify(state.orders));
            
            if (state.pendingOrder) {
                localStorage.setItem(`pendingOrder_${currentUser.phone}`, JSON.stringify(state.pendingOrder));
            }
            
            // Mark user as inactive
            currentUser.isActive = false;
            localStorage.setItem('users', JSON.stringify(state.users));
            
            // Reset state
            state.isLoggedIn = false;
            state.currentUserIndex = -1;
            state.cart = [];
            state.wishlist = [];
            state.orders = [];
            state.pendingOrder = null;
            
            showToast('با موفقیت خارج شدید', 'success');
            updateAuthUI();
            updateCartCount();
            showPage('home');
        }

        // Edit Profile Field
        function editProfileField(field) {
            state.editingProfileField = field;
            renderProfile();
        }

        // Save Profile Field
        function saveProfileField(field, value) {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            currentUser[field] = value;
            state.editingProfileField = null;
            
            // Save updated users to localStorage
            localStorage.setItem('users', JSON.stringify(state.users));
            
            showToast('تغییرات با موفقیت ذخیره شد', 'success');
            renderProfile();
        }

        // Switch Profile Tab
        function switchProfileTab(tab) {
            state.currentProfileTab = tab;
            renderProfile();
        }

        // Switch User Account
        function switchUserAccount(index) {
            // Mark all users as inactive
            state.users.forEach(user => user.isActive = false);
            
            // Mark the selected user as active
            state.users[index].isActive = true;
            state.currentUserIndex = index;
            
            // Save users to localStorage
            localStorage.setItem('users', JSON.stringify(state.users));
            
            // Load the user's data
            const user = state.users[index];
            const savedCart = localStorage.getItem(`cart_${user.phone}`);
            const savedWishlist = localStorage.getItem(`wishlist_${user.phone}`);
            const savedOrders = localStorage.getItem(`orders_${user.phone}`);
            const savedPendingOrder = localStorage.getItem(`pendingOrder_${user.phone}`);
            
            state.cart = savedCart ? JSON.parse(savedCart) : [];
            state.wishlist = savedWishlist ? JSON.parse(savedWishlist) : [];
            state.orders = savedOrders ? JSON.parse(savedOrders) : [];
            state.pendingOrder = savedPendingOrder ? JSON.parse(savedPendingOrder) : null;
            
            showToast(`به حساب ${user.name} منتقل شدید`, 'info');
            updateCartCount();
            renderProfile();
        }

        // Change Avatar
        function changeAvatar() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            avatarInput.click();
        }

        // Save Avatar
        function saveAvatar() {
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            currentUser.avatar = avatarPreview.src;
            
            // Save updated users to localStorage
            localStorage.setItem('users', JSON.stringify(state.users));
            
            showToast('تصویر پروفایل با موفقیت تغییر کرد', 'success');
            hideAvatarModal();
            renderProfile();
        }

        // Toggle Password Visibility
        function togglePasswordVisibility(input, toggleBtn) {
            if (input.type === 'password') {
                input.type = 'text';
                toggleBtn.textContent = '<i class="fas fa-eye"></i>';
            } else {
                input.type = 'password';
                toggleBtn.textContent = '<i class="fas fa-eye"></i>';
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Navigation
            navHome.addEventListener('click', () => showPage('home'));
            navCart.addEventListener('click', () => showPage('cart'));
            navOrders.addEventListener('click', () => showPage('orders'));
            navProfile.addEventListener('click', () => showPage('profile'));
            
            // Search
            searchBtn.addEventListener('click', () => {
                state.searchQuery = searchInput.value.trim();
                renderProducts();
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    state.searchQuery = searchInput.value.trim();
                    renderProducts();
                }
            });
            
            // Support
            supportBtn.addEventListener('click', () => {
                showToast('همکاران ما آماده پاسخگویی به شما هستند');
            });
            
            // Price filter inputs
            minPriceInput.addEventListener('change', () => {
                const min = parseInt(minPriceInput.value) || 0;
                const max = parseInt(maxPriceInput.value) || 10000000;
                
                if (min > max) {
                    minPriceInput.value = max;
                }
                
                renderProducts();
            });
            
            maxPriceInput.addEventListener('change', () => {
                const min = parseInt(minPriceInput.value) || 0;
                const max = parseInt(maxPriceInput.value) || 10000000;
                
                if (max < min) {
                    maxPriceInput.value = min;
                }
                
                renderProducts();
            });
            
            priceRange.addEventListener('input', () => {
                maxPriceInput.value = priceRange.value;
                renderProducts();
            });
            
            // Brand filter
            document.querySelectorAll('.brand-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.brand-item').forEach(brand => brand.classList.remove('active'));
                    item.classList.add('active');
                    renderProducts();
                });
            });
            
            // Auth buttons
            loginBtn.addEventListener('click', () => showAuthModal('login'));
            registerBtn.addEventListener('click', () => showAuthModal('register'));
            
            // Auth Modal
            authSwitchBtn.addEventListener('click', () => {
                if (authSwitchBtn.textContent === 'ثبت نام') {
                    showAuthModal('register');
                } else {
                    showAuthModal('login');
                }
            });
            
            closeAuthModal.addEventListener('click', hideAuthModal);
            
            // Password toggle buttons
            loginPasswordToggle.addEventListener('click', () => {
                togglePasswordVisibility(loginPasswordInput, loginPasswordToggle);
            });
            
            registerPasswordToggle.addEventListener('click', () => {
                togglePasswordVisibility(registerPasswordInput, registerPasswordToggle);
            });
            
            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (authSubmitBtn.textContent === 'ورود') {
                    const phone = document.getElementById('login-phone').value;
                    const password = document.getElementById('login-password').value;
                    login(phone, password);
                } else {
                    const userData = {
                        name: document.getElementById('register-name').value,
                        nationalCode: document.getElementById('register-national').value,
                        phone: document.getElementById('register-phone').value,
                        email: document.getElementById('register-email').value,
                        address: document.getElementById('register-address').value,
                        password: document.getElementById('register-password').value
                    };
                    
                    // Simple validation
                    if (!userData.name || !userData.nationalCode || !userData.phone || !userData.password) {
                        showToast('لطفا اطلاعات ضروری را وارد کنید', 'error');
                        return;
                    }
                    
                    register(userData);
                }
            });
            
            // Payment Modal
            closePaymentModal.addEventListener('click', hidePaymentModal);
            confirmPaymentBtn.addEventListener('click', confirmPayment);
            cancelPaymentBtn.addEventListener('click', cancelPayment);
            
            // Zoom Modal
            closeZoom.addEventListener('click', hideZoomModal);
            
            // Avatar Modal
            closeAvatarModal.addEventListener('click', hideAvatarModal);
            
            selectAvatarBtn.addEventListener('click', () => {
                avatarInput.click();
            });
            
            avatarInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        avatarPreview.src = event.target.result;
                        avatarPreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            saveAvatarBtn.addEventListener('click', saveAvatar);
            
            // Product interactions are handled through event delegation
            document.addEventListener('click', (e) => {
                // Add to cart from product card
                if (e.target.classList.contains('add-to-cart')) {
                    const productId = parseInt(e.target.getAttribute('data-id'));
                    addToCart(productId);
                }
                
                // Add to wishlist from product card
                if (e.target.classList.contains('add-to-wishlist')) {
                    const productId = parseInt(e.target.getAttribute('data-id'));
                    addToWishlist(productId);
                }
                
                // Add to cart from product detail
                if (e.target.classList.contains('detail-add-to-cart')) {
                    const productId = parseInt(e.target.getAttribute('data-id'));
                    addToCart(productId);
                }
                
                // Add to wishlist from product detail
                if (e.target.classList.contains('detail-add-to-wishlist')) {
                    const productId = parseInt(e.target.getAttribute('data-id'));
                    addToWishlist(productId);
                }
                
                // Cart quantity controls
                if (e.target.classList.contains('quantity-btn')) {
                    const cartItem = e.target.closest('.cart-item');
                    if (cartItem) {
                        const productId = parseInt(cartItem.getAttribute('data-id'));
                        const isPlus = e.target.classList.contains('plus');
                        updateCartItemQuantity(productId, isPlus ? 1 : -1);
                    }
                }
                
                // Remove from cart
                if (e.target.classList.contains('cart-item-remove')) {
                    const cartItem = e.target.closest('.cart-item');
                    if (cartItem) {
                        const productId = parseInt(cartItem.getAttribute('data-id'));
                        removeFromCart(productId);
                    }
                }
                
                // Remove from wishlist
                if (e.target.classList.contains('wishlist-item-remove')) {
                    const wishlistItem = e.target.closest('.wishlist-item');
                    if (wishlistItem) {
                        const productId = parseInt(wishlistItem.getAttribute('data-id'));
                        addToWishlist(productId); // Toggle will remove it
                    }
                }
                
                // Checkout button
                if (e.target.classList.contains('checkout-btn')) {
                    checkout();
                }
                
                // Payment button
                if (e.target.classList.contains('payment-btn')) {
                    completePayment();
                }
                
                // Delivery method selection
                if (e.target.classList.contains('method-item') || e.target.closest('.method-item')) {
                    const methodItem = e.target.classList.contains('method-item') ? e.target : e.target.closest('.method-item');
                    document.querySelectorAll('.method-item').forEach(item => item.classList.remove('active'));
                    methodItem.classList.add('active');
                    
                    if (state.pendingOrder) {
                        state.pendingOrder.deliveryMethod = {
                            type: methodItem.getAttribute('data-type'),
                            price: parseInt(methodItem.getAttribute('data-price'))
                        };
                        const currentUser = getCurrentUser();
                        if (currentUser) {
                            localStorage.setItem(`pendingOrder_${currentUser.phone}`, JSON.stringify(state.pendingOrder));
                        }
                    } else {
                        state.deliveryMethod = {
                            type: methodItem.getAttribute('data-type'),
                            price: parseInt(methodItem.getAttribute('data-price'))
                        };
                    }
                    
                    renderCheckout();
                }
                
                // Delivery time selection
                if (e.target.classList.contains('time-item') || e.target.closest('.time-item')) {
                    const timeItem = e.target.classList.contains('time-item') ? e.target : e.target.closest('.time-item');
                    document.querySelectorAll('.time-item').forEach(item => item.classList.remove('active'));
                    timeItem.classList.add('active');
                    
                    if (state.pendingOrder) {
                        state.pendingOrder.deliveryTime = {
                            time: timeItem.getAttribute('data-time'),
                            extraPrice: parseInt(timeItem.getAttribute('data-price'))
                        };
                        const currentUser = getCurrentUser();
                        if (currentUser) {
                            localStorage.setItem(`pendingOrder_${currentUser.phone}`, JSON.stringify(state.pendingOrder));
                        }
                    } else {
                        state.deliveryTime = {
                            time: timeItem.getAttribute('data-time'),
                            extraPrice: parseInt(timeItem.getAttribute('data-price'))
                        };
                    }
                    
                    renderCheckout();
                }
                
                // Payment method selection
                if (e.target.classList.contains('payment-item') || e.target.closest('.payment-item')) {
                    const paymentItem = e.target.classList.contains('payment-item') ? e.target : e.target.closest('.payment-item');
                    document.querySelectorAll('.payment-item').forEach(item => item.classList.remove('active'));
                    paymentItem.classList.add('active');
                    
                    if (state.pendingOrder) {
                        state.pendingOrder.paymentMethod = paymentItem.getAttribute('data-method');
                        const currentUser = getCurrentUser();
                        if (currentUser) {
                            localStorage.setItem(`pendingOrder_${currentUser.phone}`, JSON.stringify(state.pendingOrder));
                        }
                    } else {
                        state.paymentMethod = paymentItem.getAttribute('data-method');
                    }
                    
                    renderCheckout();
                }
                
                // Profile menu items
                if (e.target.classList.contains('profile-menu-item') || e.target.closest('.profile-menu-item')) {
                    const menuItem = e.target.classList.contains('profile-menu-item') ? e.target : e.target.closest('.profile-menu-item');
                    if (menuItem.id === 'logout-btn') {
                        logout();
                    } else {
                        const tab = menuItem.getAttribute('data-tab');
                        if (tab) {
                            switchProfileTab(tab);
                        }
                    }
                }
                
                // Edit profile field
                if (e.target.classList.contains('edit-btn')) {
                    const field = e.target.getAttribute('data-field');
                    editProfileField(field);
                }
                
                // Save profile field
                if (e.target.classList.contains('save-btn')) {
                    const field = e.target.getAttribute('data-field');
                    const value = document.getElementById(`edit-${field}`).value;
                    saveProfileField(field, value);
                }
                
                // Account switcher
                if (e.target.id === 'account-switcher' || e.target.closest('#account-switcher')) {
                    const dropdown = document.getElementById('account-dropdown');
                    dropdown.classList.toggle('show');
                    
                    // Toggle arrow icon
                    const switcher = document.getElementById('account-switcher');
                    switcher.classList.toggle('active');
                }
                
                // Switch account
                if (e.target.classList.contains('account-item') || e.target.closest('.account-item')) {
                    const accountItem = e.target.classList.contains('account-item') ? e.target : e.target.closest('.account-item');
                    if (accountItem.id === 'add-account') {
                        showAuthModal('register');
                    } else {
                        const index = parseInt(accountItem.getAttribute('data-index'));
                        switchUserAccount(index);
                    }
                    
                    // Hide dropdown
                    document.getElementById('account-dropdown').classList.remove('show');
                    document.getElementById('account-switcher').classList.remove('active');
                }
                
                // Add avatar button
                if (e.target.id === 'add-avatar-btn' || e.target.closest('#add-avatar-btn')) {
                    showAvatarModal();
                }
                
                // Order item click (for pending orders)
                if (e.target.classList.contains('order-item') || e.target.closest('.order-item')) {
                    const orderItem = e.target.classList.contains('order-item') ? e.target : e.target.closest('.order-item');
                    const orderId = parseInt(orderItem.getAttribute('data-id'));
                    
                    // Check if this is a pending order
                    if (state.pendingOrder && state.pendingOrder.id === orderId) {
                        // Set cart to pending order items
                        state.cart = [...state.pendingOrder.items];
                        const currentUser = getCurrentUser();
                        if (currentUser) {
                            localStorage.setItem(`cart_${currentUser.phone}`, JSON.stringify(state.cart));
                        }
                        
                        // Set delivery and payment methods
                        state.deliveryMethod = {...state.pendingOrder.deliveryMethod};
                        state.deliveryTime = {...state.pendingOrder.deliveryTime};
                        state.paymentMethod = state.pendingOrder.paymentMethod;
                        
                        updateCartCount();
                        renderCheckout();
                    }
                }
            });
            
            // Close account dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.profile-name')) {
                    const dropdown = document.getElementById('account-dropdown');
                    if (dropdown) dropdown.classList.remove('show');
                    
                    const switcher = document.getElementById('account-switcher');
                    if (switcher) switcher.classList.remove('active');
                }
            });
        }

        // Initialize the app
        init();

    </script>
</body>
</html>